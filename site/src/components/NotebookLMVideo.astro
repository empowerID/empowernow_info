---
/**
 Props:
 - url: public share URL to a NotebookLM Video Overview (must be accessible)
 - title: accessible title for the iframe
 - poster?: optional image shown before loading (deferred mode)
 - defer?: when true, renders a clickable poster that swaps in the iframe on demand
 - aspect?: e.g., '16/9' or '4/3' (defaults to 16/9)
 - allow?: iframe allow list (sane defaults provided)
 - cookies?: 'omit' | 'lax' | 'include' for referrerpolicy/sandbox tuning (default 'omit')
*/
interface Props {
  url: string;
  title: string;
  poster?: string;
  defer?: boolean;
  aspect?: string;
  allow?: string;
  cookies?: 'omit' | 'lax' | 'include';
}
const p = Astro.props as Props;
const aspect = p.aspect || '16/9';
const allow = p.allow || 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
const referrer = p.cookies === 'include' ? 'no-referrer-when-downgrade' : 'no-referrer';
---
<div class="nlm-wrap" style={`--aspect:${aspect}`}> 
  {p.defer && p.poster ? (
    <button class="nlm-defer" type="button" aria-label={`Play video: ${p.title}`}> 
      <img src={p.poster} alt="" loading="lazy" />
      <span class="nlm-play" aria-hidden="true">â–¶</span>
    </button>
  ) : (
    <iframe
      src={p.url}
      title={p.title}
      loading="lazy"
      allow={allow}
      allowfullscreen
      referrerpolicy={referrer}
      sandbox="allow-scripts allow-same-origin allow-presentation allow-popups"
    ></iframe>
  )}
</div>

{p.defer && p.poster && (
  <script>
    document.currentScript?.previousElementSibling?.querySelector('.nlm-defer')?.addEventListener('click', (e) => {
      const btn = e.currentTarget as HTMLButtonElement;
      const wrap = btn.closest('.nlm-wrap') as HTMLElement;
      if (!wrap) return;
      const iframe = document.createElement('iframe');
      iframe.src = {p.url};
      iframe.title = {p.title};
      iframe.loading = 'eager';
      iframe.allow = {allow};
      iframe.setAttribute('allowfullscreen', '');
      iframe.referrerPolicy = {referrer};
      iframe.sandbox.add('allow-scripts', 'allow-same-origin', 'allow-presentation', 'allow-popups');
      wrap.replaceChildren(iframe);
    });
  </script>
)}

<style>
  .nlm-wrap{position:relative;isolation:isolate}
  .nlm-wrap::before{content:'';display:block;aspect-ratio:var(--aspect);}
  .nlm-wrap>iframe,.nlm-wrap>.nlm-defer{position:absolute;inset:0;width:100%;height:100%;border:0;border-radius:12px;background:var(--surface-2)}
  .nlm-defer{padding:0;cursor:pointer;border:1px solid var(--border-soft);overflow:hidden}
  .nlm-defer img{width:100%;height:100%;object-fit:cover;display:block;filter:brightness(.9)}
  .nlm-play{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:inline-grid;place-items:center;width:64px;height:64px;border-radius:999px;background:rgba(0,0,0,.45);box-shadow:0 10px 30px rgba(0,0,0,.35);color:#fff;font-size:28px}
  .nlm-defer:focus-visible{outline:3px solid var(--color-accent);outline-offset:2px}
</style>

